{% extends 'music_downloader/base.html' %}

{% block title %}{{ playlist.title }} - Yandex Music Downloader{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-music-note-list"></i> {{ playlist.title }}</h4>
            </div>
            <div class="card-body">
                <p><strong>Количество треков:</strong> {{ playlist.track_count }}</p>
                <p><strong>Владелец:</strong> {{ playlist.owner }}</p>
                {% if downloaded_count > 0 %}
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle"></i> Уже скачано: {{ downloaded_count }} / {{ playlist.track_count }} треков
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Выберите треки для скачивания</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-light" onclick="selectAll()">
                            <i class="bi bi-check-all"></i> Выбрать все
                        </button>
                        <button type="button" class="btn btn-sm btn-light" onclick="deselectAll()">
                            <i class="bi bi-x-square"></i> Снять все
                        </button>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small>Всего треков: {{ total_tracks }}</small>
                    <div>
                        <label class="text-white me-2"><small>Показывать по:</small></label>
                        <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="changePerPage(this.value)">
                            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'download_tracks' playlist.id %}" id="downloadForm">
                    {% csrf_token %}
                    
                    {% if tracks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleAll(this)">
                                    </th>
                                    <th>#</th>
                                    <th>Название</th>
                                    <th>Исполнитель</th>
                                    <th>Длительность</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for track in tracks %}
                                <tr {% if track.is_downloaded %}class="table-success"{% endif %}>
                                    <td>
                                        <input type="checkbox" class="form-check-input track-checkbox" 
                                               name="tracks" value="{{ track.yandex_track_id }}"
                                               {% if track.is_downloaded %}checked disabled{% endif %}>
                                    </td>
                                    <td>{{ track.position|add:1 }}</td>
                                    <td>
                                        <i class="bi bi-music-note"></i> {{ track.title }}
                                        {% if track.is_downloaded %}
                                            <i class="bi bi-check-circle-fill text-success" title="Уже скачан"></i>
                                        {% endif %}
                                    </td>
                                    <td>{{ track.artist }}</td>
                                    <td>
                                        {% if track.duration %}
                                            {{ track.duration|floatformat:0|default:"0" }}с
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="selectedCount">0</span> треков выбрано
                        </div>
                        <div>
                            <button type="submit" class="btn btn-success btn-lg" id="downloadBtn" disabled>
                                <i class="bi bi-download"></i> Скачать выбранные
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-secondary btn-lg">
                                <i class="bi bi-arrow-left"></i> Назад
                            </a>
                        </div>
                    </div>
                    
                    <!-- Пагинация -->
                    {% if page_obj.has_other_pages %}
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1&per_page={{ per_page }}">Первая</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}">Предыдущая</a>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}">Следующая</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&per_page={{ per_page }}">Последняя</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <p class="text-center text-muted">Нет доступных треков</p>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function changePerPage(value) {
        const url = new URL(window.location);
        url.searchParams.set('per_page', value);
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }
    
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.track-checkbox:checked:not([disabled])');
        const count = checkboxes.length;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('downloadBtn').disabled = count === 0;
        
        // Обновляем состояние главного чекбокса
        const allCheckboxes = document.querySelectorAll('.track-checkbox:not([disabled])');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
    }
    
    function toggleAll(checkbox) {
        const trackCheckboxes = document.querySelectorAll('.track-checkbox:not([disabled])');
        trackCheckboxes.forEach(cb => cb.checked = checkbox.checked);
        updateSelectedCount();
    }
    
    function selectAll() {
        document.querySelectorAll('.track-checkbox:not([disabled])').forEach(cb => cb.checked = true);
        document.getElementById('selectAllCheckbox').checked = true;
        updateSelectedCount();
    }
    
    function deselectAll() {
        document.querySelectorAll('.track-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateSelectedCount();
    }
    
    // Добавляем обработчик для всех чекбоксов треков
    document.querySelectorAll('.track-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // Инициализируем счетчик
    updateSelectedCount();
</script>
{% endblock %}
